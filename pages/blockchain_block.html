<div class="tile is-ancestor">
	<div class="tile is-parent is-12">
		<div class="tile">
			<article class="tile is-child notification">
				<p class="title size-is-4">Block</p>
				<div class="columns">
					<div class="column">
						<div>Block Hash: <span id="block_hash"><span id="block.hash"></span></span></div>
						<div>Height: <span id="block_height"><span id="block.height"></span></span></div>
						<div>Timestamp: <span id="block.timestamp"></span></div>
						<div>Version: <span id="block.version"></span></div>
						<div>Difficulty: <span id="block.difficulty"></span></div>
						<div>Orphan: <span id="block.orphan"></span></div>
						<div>Tx: <span id="block.transactions"></span></a></div>
						<div>Total Supply: <span id="block.totalCoins"></span></div>
						<div>Total Tx: <span id="block.totalTransactions"></span></div>
					</div>

					<div class="column">
						<div>Tx Size: <span id="block.transactionsSize"></span></div>
						<div>Block Size: <span id="block.blockSize"></span></div>
						<div>Tx Median: <span id="block.currentTxsMedian"></span></div>
						<div>Effective Tx Median: <span id="block.effectiveTxsMedian"></span></div>
						<div>Reward Penalty: <span id="block.rewardPenalty"></span></div>
						<div>Base Reward: <span id="block.baseReward"></span></div>
						<div>Tx Fee: <span id="block.transactionsFee"></span></div>
						<div>Reward: <span id="block.reward"></span></div>
					</div>
				</div>
			</article>
		</div>
	</div>

<div class="tile is-ancestor">
	<div class="tile is-parent is-12">
		<div class="tile">
			<article class="tile is-child notification">
				<p class="title size-is-4">Ð¢ransactions></p>
				<div class="table">
					<table class="table table-hover is-size-6">
						<thead>
						<tr>
							<th><i class="fa fa-paw"></i> Hash</th>
							<th><i class="fa fa-percent"></i> Fee</th>
							<th><i class="fa fa-money"></i> Total Amount</th>
							<th><i class="fa fa-arrows"></i> Size</th>
						</tr>
						</thead>
						<tbody id="transactions_rows"></tbody>
					</table>
				</div>
			</article>
		</div>
	</div>
</div>

<script>
    var block, xhrGetBlock;

    currentPage = {
        destroy: function(){
            if (xhrGetBlock) xhrGetBlock.abort();
        },
        init: function(){
            getBlock();
        },
        update: function(){
        }
    };

    function getBlock(){
        if (xhrGetBlock) xhrGetBlock.abort();
		var searchBlk = $.parseJSON(sessionStorage.getItem('searchBlock'));
		if (searchBlk) {
			renderBlock(searchBlk);
		} else {
			xhrGetBlock = $.ajax({
				url: api + '/json_rpc',
				method: "POST",
				data: JSON.stringify({
					jsonrpc:"2.0",
					id: "test",
					method:"f_block_json",
					params: {
						hash: urlParam('hash')
					}
				}),
				dataType: 'json',
				cache: 'false',
				success: function(data){
					block = data.result.block;
					renderBlock(block);
				}
			});
		}
		sessionStorage.removeItem('searchBlock');
    }
	
	function renderBlock(block){
				updateText('block.hash', block.hash);
				updateText('block.height', localizeNumber(block.height));
				updateText('block.timestamp', formatDate(block.timestamp));
				updateText('block.version', block.major_version + '.' + block.minor_version);
				updateText('block.difficulty', localizeNumber(block.difficulty));
				updateText('block.orphan', block.orphan_status ? "YES" : "NO");
				updateText('block.transactions', block.transactions.length);
				updateText('block.transactionsSize', localizeNumber(block.transactionsCumulativeSize));
				updateText('block.blockSize', localizeNumber(block.blockSize));
				updateText('block.currentTxsMedian', localizeNumber(block.sizeMedian));
				updateText('block.effectiveTxsMedian', localizeNumber(block.effectiveSizeMedian));
				updateText('block.rewardPenalty', block.penalty*100 + "%");
				updateText('block.baseReward', getReadableCoins(block.baseReward));
				updateText('block.transactionsFee', getReadableCoins(block.totalFeeAmount));
				updateText('block.reward', getReadableCoins(block.reward));
				updateText('block.totalCoins', getReadableCoins(block.alreadyGeneratedCoins));
				updateText('block.totalTransactions', localizeNumber(block.alreadyGeneratedTransactions));
				renderTransactions(block.transactions);
			
				makePrevBlockLink(block.prev_hash);
				
				$.ajax({
					url: api + '/json_rpc',
					method: "POST",
					data: JSON.stringify({
					jsonrpc: "2.0",
					id: "test",
					method: "getblockheaderbyheight",
					params: {
						height: (block.height + 1)
					}
					}),
					dataType: 'json',
					cache: 'false',
					success: function(data){
					  if(data.result){
						var nextBlockHash = data.result.block_header.hash;
					  }
						 if(nextBlockHash) {
							makeNextBlockLink(nextBlockHash);
						 }
					},
					error: function (ajaxContext) {
					}
				});
	
	}
	
    function getTransactionCells(transaction){
        return '<td>' + formatPaymentLink(transaction.hash) + '</td>' +
               '<td>' + getReadableCoins(transaction.fee, 4, true) + '</td>' +
               '<td>' + getReadableCoins(transaction.amount_out, 4, true) + '</td>' +
               '<td>' + localizeNumber(transaction.size) + '</td>';
    }

    function getTransactionRowElement(transaction, jsonString){

        var row = document.createElement('tr');
        row.setAttribute('data-json', jsonString);
        row.setAttribute('data-hash', transaction.hash);
        row.setAttribute('id', 'transactionRow' + transaction.hash);

        row.innerHTML = getTransactionCells(transaction);

        return row;
    }

    function renderTransactions(transactionResults){

        var $transactionsRows = $('#transactions_rows');

        for (var i = 0; i < transactionResults.length; i++){

            var transaction = transactionResults[i];

            var transactionJson = JSON.stringify(transaction);

            var existingRow = document.getElementById('transactionRow' + transaction.hash);

            if (existingRow && existingRow.getAttribute('data-json') !== transactionJson){
                $(existingRow).replaceWith(getTransactionRowElement(transaction, transactionJson));
            }
            else if (!existingRow){

                var transactionElement = getTransactionRowElement(transaction, transactionJson);
                $transactionsRows.append(transactionElement);
            }

        }
    }
	
	function makeNextBlockLink(blockHash){
		$('#block_height').prepend('<a href="' + getBlockchainUrl(blockHash) + '" title="Next block"><i class="fa fa-chevron-circle-left" aria-hidden="true"></i></a> ');
	}
	
	function makePrevBlockLink(blockHash){
		$('#block_height').append(' <a href="' + getBlockchainUrl(blockHash) + '" title="Previous block"><i class="fa fa-chevron-circle-right" aria-hidden="true"></i></a>');
	}
	
	function formatPrevNextBlockLink(hash){
        return '<a href="' + getBlockchainUrl(hash) + '">' + hash + '</a>';
    }
	
	$(function() {
		$('[data-toggle="tooltip"]').tooltip();
	});
	
</script>
